name: Unit tests

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test-ubuntu-macos:
    strategy:
      matrix:
        platform:
          - macos-latest
          - ubuntu-latest
        python:
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          persist-credentials: false

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@2e657c127d5b1635d5a8e3fa40e0ac50a5bf6992 # v3
        with:
          version: "0.4.18"
          enable-cache: true
          cache-dependency-glob: pyproject.toml

      - name: Install Python ${{ matrix.python }}
        run: uv python install ${{ matrix.python }}

      - name: test
        run: make test INSTALL_EXTRA=test

  test-windows:
    strategy:
      matrix:
        windows:
          - 'win64'
        python:
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"

    runs-on: windows-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          persist-credentials: false

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@2e657c127d5b1635d5a8e3fa40e0ac50a5bf6992 # v3
        with:
          version: "0.4.18"
          enable-cache: true
          cache-dependency-glob: pyproject.toml

      - name: Install Python ${{ matrix.python }}
        run: uv python install ${{ matrix.python }}

      - uses: dawidd6/action-download-artifact@bf251b5aa9c2f7eeb574a96ee720e24f801b7c11 # v6
        with:
          repo: pyca/infra
          workflow: build-windows-openssl.yml
          branch: main
          workflow_conclusion: success
          name: "openssl-${{ matrix.windows }}"
          path: "C:/openssl-${{ matrix.windows }}/"
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure
        shell: bash
        run: |
          echo "OPENSSL_DIR=C:/openssl-${{ matrix.windows }}" >> $GITHUB_ENV
          echo "OPENSSL_NO_VENDOR=1" >> $GITHUB_ENV

      - name: test
        run: |
          make test INSTALL_EXTRA=test
        shell: bash

  all-tests-pass:
    if: always()

    needs: [test-ubuntu-macos, test-windows]

    runs-on: ubuntu-latest

    steps:
      - name: check test jobs
        uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe # v1.2.2
        with:
          jobs: ${{ toJSON(needs) }}
